
<!DOCTYPE html>
<html>
<head>
<title>Device Switching</title>
<style>
video {
    border:5px solid black;
    width:480px;
    height:360px;
}
button {
    font: 18px sans-serif;
    padding: 8px;
}
.pic {
    border: 2px solid yellow;
}
.preview {
    border: 3px dashed blue;
}
#scanner {
    border: 1px dotted green;
}
</style>
<script type="text/javascript" src="js/async.js"></script>
<script>

//var cameras = [];         // array to hold all camera objects
//var activeCam = {};       // object for the camera being streamed
//var scanCam = {};         // counter for the camera having its preview generated
//var scanInterval = 3000;  // scan cameras for snapshots every this milliseconds
var initDelay = 1000;

//var mainStream;
//var nextCam = 0;
//var sourceIDs = new Array();

</script>
</head>
<body onload="start()">
<button id="btn" onclick="another()">Please may I have another?</button>
<button id="snap" onclick="snapshot()">snapshot</button>

<div id="previews">
    <canvas class="pic" id="pic"></canvas>
</div>

<div id="scanner"></div>

<div id="live">
  <!-- camera preview images go here -->
</div>
<br>

<script>


function failure(e) {
  console.log("Failure");
  alert(e.name)
}

function start() {

    // make sure browser is supported
    navigator.getUserMedia = ( navigator.getUserMedia ||
			       navigator.webkitGetUserMedia ||
			       navigator.mozGetUserMedia ||
			       navigator.msGetUserMedia );

    if (!navigator.getUserMedia) throw new Error('browser does not support getUserMedia.');
    if (!MediaStreamTrack.getSources) throw new Error('Browser does not support MediaStreamTrack.getsources(). Try Chrome.');

    // get video sources connected to this machine
    discoverCams(function(err, cameras) {

	// for each camera, create a preview window
	async.eachSeries(cameras, function(camera, callback) {

	    var camNum = cameras.indexOf(camera);
	    
	    // In the previews section, display a placeholder box for each detected camera
	    console.log('adding a preview for camera ' + camNum);
	    preview = document.createElement('canvas');
	    preview.setAttribute("class", "preview");
	    preview.setAttribute("id", "preview" + camNum);
	    previews.appendChild(preview);
	    callback();
	    
	}, function() {
	    // when all previews have been made


	// for each camera
	    // open stream,
	    // add stream to video#live,
	    // copy video frame to canvas#preview* (where * is camera index)
	    // close stream
	    
	async.eachSeries(cameras, function(camera, callback) {
	    
	    //ccc
	    
	    // get camera source id
	    id = camera.id;

	    // get camera stream
	    startStream(id, function(stream) {

		// get scanner div
		var scanDiv = document.getElementById('scanner');
		
		// create scanner video element
		var scanVid = document.createElement('video');
		
		// set src of video element to camera stream
		scanVid.src = webkitURL.createObjectURL(stream);
		scanVid.autoplay = true;

		// add video element to scanner
		scanner.appendChild(scanVid);

		var camNum = cameras.indexOf(camera);
		var id = 'preview' + camNum;
		
		var canvas = document.getElementById(id);
		console.log('getting canvas ' + canvas);
		console.dir(canvas);
		
		// wait 1s for camera to init
		setTimeout(function() {
		    
		    // send snapshot to .preview + i
		    // @todo get aspect ratio, scale preview thumbnail accordingly				    
		    
		    console.log('snapshot func');

		    canvas.style.border='3px dashed red';
		    
		    var ctx = canvas.getContext("2d");
		    ctx.drawImage(scanVid, 0, 0, 480, 360, 0, 0, 150, 84);

		    // close camera stream
		    console.dir(stream);
		    stream.stop();

		    // remove the video element from the scanner div
		    scanDiv.removeChild(scanVid);
		    
		    // the scan of this camera is finished
		    callback();		    

		}, initDelay);
		    
		
		

		


		

		//var video = activeCam.el;
		//console.dir(video);
		//console.log('vid width:'+video.videoWidth+' vid height:'+video.videoHeight);
		//var id = 'preview' + activeCam.el.id
		//console.log('cam?' + id);

		

		
		// close camera stream



	    });
		
	}, function(err) { 
	    // When iteration done for all cameras
	    
	});
	
			
	    
	});	    


	    
	    
	    

    });	
}

function discoverCams(callback) {
  
    // get audio and video sources connected to this machine
    MediaStreamTrack.getSources(function(sources) {

	var cameras = [];
	var vidCount = 0;
	// iterate through each found source and add the videos to an array
	for (var i=0; i < sources.length; i++) {
            console.log(sources[i])
            if (sources[i].kind == 'video') {
		// the iterated source info is a video source
		
		// add the source id to the cameras array
		// and add a 'live' flag for use later
		var obj = {};
		obj['id'] = sources[i].id;
		obj['live'] = 'false';
		cameras.push(obj);
		vidCount++;
		
            }
	    // once all sources have been checked, callback with all the camera objects (containing video sources)
	    if (i == sources.length-1) return callback(null, cameras);
	}
    });
}


function gotStream(stream) {
    console.log("Gotstream " + stream.id);
    
    // create new video element
    var newvid = document.createElement('video');
    
    // set src of video element to stream and make it play
    newvid.src = webkitURL.createObjectURL(stream);
    newvid.autoplay = true;
    
    // add video element to live div
    live.appendChild(newvid);
    
    // store reference to this video/stream in the activeCam object
    activeCam.el = newvid;
    activeCam.stream = stream;
    //activeCam.number 
}

function snapshot(camera) {

}

function scanCams() {
    var scanTimer = setInterval(function() {
	console.log('scanning camera ' + scanCam);
	
	// close stream to last camera
	console.dir(activeCam.stream);
	activeCam.stream.stop();
	
	// open stream from new camera
	var stream = startStream(camToId(nextScanCam()));
	
	// wait for camera to init
	// take snapshot
	setTimeout(snapshot, initDelay);
	

    }, scanInterval);
}				

function startStream(id, callback) {
    navigator.getUserMedia({ video: {optional: [{sourceId: id}]}},
			   callback,
			   function(err) { return console.log(err) });	    
}

function nextScanCam() {
    var totalCam = sourceIDs.length;
    var next = nextCam + 1;

    if (next > totalCam) {
	return nextCam = 0;
    } else {
	return nextCam++;
    }
}

/**
 * camToId
 *
 * Convenience function. Converts camera number to camera source ID
 *
 * @param {int} cam      The zero-indexed camera number out of all discovered cameras
 * @return {String}      The camera source ID
 */
function camToId(cam) {
    return sourceIDs[cam];
}
/**
 * idToCam
 *
 * Convenience function. Converts camera source ID to camera number
 *
 * @param {String} id    The unique camera source ID
 * @return {int}         The zero-indexed camera number
 */
function idToCam(id) {
    throw new Error('idk my bff jill');
}


function another() {
    // set the video to the display
    //console.log('setting' +  sourceInfos[i].id);
    //console.log('adding: ' + sourceIDs[nextCam++]);
    
    navigator.getUserMedia({ video: {optional: [{sourceId: sourceIDs[nextCam++]}]}},
			   gotStream,
			   function(err) {console.log(err)});
}

function gotSources(sourceInfos) {
}

//video = document.getElementById("vid");
var live = document.getElementById("live");
var scanner = document.getElementById("scanner");
var previews = document.getElementById("previews");

</script>
</body>
</html>

